<?php

/**
 * @file
 * Linkit hook implementations.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;

/**
 * Implements hook_ckeditor_plugin_info_alter().
 */
function linkit_ckeditor_plugin_info_alter(array &$plugins) {
  if (isset($plugins['drupallink'])) {
    $plugins['drupallink']['class'] = "Drupal\\linkit\\Plugin\\CKEditorPlugin\\LinkitDrupalLink";
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function linkit_form_editor_link_dialog_alter(&$form, FormStateInterface $form_state, $form_id) {
  $user_input = $form_state->getUserInput();
  /** @var Drupal\filter\Entity\FilterFormat $filter_format */
  $filter_format = $form_state->getBuildInfo()['args'][0];
  $input = isset($user_input['editor_object']) ? $user_input['editor_object'] : [];

  /** @var \Drupal\Core\Entity\EntityStorageInterface $editorStorage */
  $editorStorage = Drupal::service('entity.manager')->getStorage('editor');

  /** @var \Drupal\editor\EditorInterface $editor */
  $editor = $editorStorage->load($filter_format->id());
  $plugin_settings = $editor->getSettings()['plugins']['drupallink'];

  // Do not alter the form if Linkit is not enabled for this text format.
  if (!isset($plugin_settings['linkit_enabled']) || (isset($plugin_settings['linkit_enabled']) && !$plugin_settings['linkit_enabled'])) {
    return;
  }

  $linkit_profile_id = $editor->getSettings()['plugins']['drupallink']['linkit_profile'];
  /** @var \Drupal\linkit\Entity\Profile $linkit_profile */
  $linkit_profile = Drupal::entityTypeManager()->getStorage('linkit_profile')->load($linkit_profile_id);

  // Everything under the "attributes" key is merged directly into the
  // generated link tag's attributes.
  $form['attributes']['href'] = [
    '#title' => t('Link'),
    '#type' => 'linkit',
    '#default_value' => isset($input['href']) ? $input['href'] : '',
    '#description' => t('Start typing to find content or paste a URL.'),
    '#autocomplete_route_name' => 'linkit.autocomplete',
    '#autocomplete_route_parameters' => [
      'linkit_profile_id' => $linkit_profile_id,
    ],
    '#weight' => 0,
  ];

  // Add IMCE button if IMCE is installed and enabled for the given profile.
  if (Drupal::service('module_handler')->moduleExists('imce') && $linkit_profile->getThirdPartySetting('imce', 'use', FALSE)) {
    $form['imce-link'] = [
      '#type' => 'link',
      '#title' => t('Open IMCE file browser'),
      '#url' => Url::fromRoute('imce.page', [
        'scheme' => $linkit_profile->getThirdPartySetting('imce', 'scheme', 'public'),
      ]),
      '#options' => [
        'query' => [
          'sendto' => 'linkitImce.sendto',
        ],
      ],
      '#attributes' => [
        'class' => ['linkit-imce-open'],
      ],
      '#attached' => [
        'library' => [
          'linkit/linkit.imce',
        ],
      ],
      '#weight' => 1,
    ];
  }

  // Add #validate callback that generates data-entity-type and
  // data-entity-uuid attributes from the href attribute when appropriate.
  array_unshift($form['#validate'], 'linkit_form_editor_link_dialog_validate');
}

/**
 * Generates data-entity-type and data-entity-uuid attributes from href.
 */
function linkit_form_editor_link_dialog_validate(array &$form, FormStateInterface $form_state) {
  // Check if the 'href' attribute contains a entity: URI.
  $href = $form_state->getValue(['attributes', 'href']);
  $uri_parts = parse_url($href);
  if ($uri_parts['scheme'] !== 'entity') {
    return;
  }

  // Parse the entity: URI into an entity type ID and entity ID.
  list($entity_type_id, $entity_id) = explode('/', $uri_parts['path'], 2);

  // Load the entity and populate the data-entity-type and data-entity-uuid
  // attributes as expected by filters.
  // @see \Drupal\editor\Plugin\Filter\EditorFileReference
  // @see \Drupal\linkit\Plugin\Filter\LinkitFilter
  try {
    if (!$entity = \Drupal::entityTypeManager()->getStorage($entity_type_id)->load($entity_id)) {
      $form_state->setError($form['attributes']['href'], t('Invalid URI'));
    }
    else {
      $form_state->setValue(['attributes', 'data-entity-type'], $entity_type_id);
      $form_state->setValue(['attributes', 'data-entity-uuid'], $entity->uuid());
    }
  }
  catch (Exception $exception) {
    $form_state->setError($form['attributes']['href'], t('Invalid URI'));
  }

}
